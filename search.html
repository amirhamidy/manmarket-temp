<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جستجوی پیشرفته (اصلاح نهایی با پیشوند fill-)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet" integrity="sha384-nU14brUcp6StFntEOOEBvcJm4huWjB0OcIeQ3fltAfSmuZFrkAif0T+UtNGlKKQv" crossorigin="anonymous">
    <style>
        :root {
            --font-family-base: 'Vazirmatn', Arial, sans-serif;
            --primary-accent: #FF6B6B;
            --primary-accent-rgb: 255, 107, 107;
            --primary-accent-lighter: #ff9a9a;
            --primary-accent-darker: #EE5253;
            --secondary-accent: #4ECDC4;
            --text-primary: #2c3a47;
            --text-secondary: #57606f;
            --text-muted: #8395a7;
            --bg-primary: #f5f6fa;
            --bg-secondary: #ffffff;
            --border-color: #dfe4ea;
            --border-color-light: #f1f2f6;
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 10px rgba(0,0,0,0.08);
            --spacing-unit: 8px;
            --transition-base: all 0.25s ease-out;

            --cubic-bezier-tick-bg: cubic-bezier(0.34, 1.56, 0.64, 1);
            --transition-tick-bg-duration: 0.28s;
            --tick-path-length: 14.5; /* This will be updated by JS */
            --transition-tick-draw-duration: 0.3s;
            --transition-tick-draw-delay: 0.15s;
            --cubic-bezier-tick-draw: ease-in-out;
            --transition-tick-bg-anim: transform var(--transition-tick-bg-duration) var(--cubic-bezier-tick-bg), background-color var(--transition-tick-bg-duration) ease-out;

            --bs-body-font-family: var(--font-family-base);
            --bs-body-color: var(--text-primary);
            --bs-body-bg: var(--bg-primary);
            --bs-accordion-active-color: var(--primary-accent);
            --bs-accordion-active-bg: transparent;
            --bs-accordion-btn-focus-box-shadow: none;
            --bs-accordion-btn-focus-border-color: transparent;
            --bs-accordion-border-width: 0;
            --bs-accordion-border-radius: 0;
            --bs-accordion-inner-border-radius: 0;
            --bs-accordion-btn-padding-x: calc(var(--spacing-unit) * 1.5);
            --bs-accordion-btn-padding-y: calc(var(--spacing-unit) * 1.5);
            --bs-accordion-body-padding-x: calc(var(--spacing-unit) * 1.5);
            --bs-accordion-body-padding-y: calc(var(--spacing-unit) * 1);
        }

        body { line-height: 1.6; scrollbar-width: none; -ms-overflow-style: none; }
        body::-webkit-scrollbar { display: none; }

        .fill-filters-sidebar-container {
            background-color: var(--bg-secondary); padding: calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius-md); box-shadow: var(--shadow-md);
            align-self: flex-start; position: sticky; top: calc(var(--spacing-unit) * 2);
            max-height: calc(100vh - (var(--spacing-unit) * 4)); overflow-y: auto;
            scrollbar-width: thin; scrollbar-color: var(--border-color) var(--bg-secondary);
        }
        .fill-filters-sidebar-container::-webkit-scrollbar { width: 6px; }
        .fill-filters-sidebar-container::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 3px; }
        .fill-filters-sidebar-container::-webkit-scrollbar-track { background-color: var(--bg-secondary); }

        .fill-sidebar-header {
            font-size: 1.25rem; font-weight: 700; margin-bottom: calc(var(--spacing-unit) * 2);
            padding-bottom: calc(var(--spacing-unit) * 1); border-bottom: 1px solid var(--border-color);
            text-align: center;
        }
        .fill-sidebar-header-hidden-in-offcanvas {
            display: none !important;
        }

        /* Bootstrap accordion customizations are not prefixed as they modify Bootstrap's own classes */
        .accordion-button {
            font-weight: 600; font-size: 1rem; background-color: transparent !important;
            border-right: 3px solid transparent;
            padding-right: calc(var(--spacing-unit) * 1.5 - 3px + var(--spacing-unit) * 0.5); /* Adjusted padding */
            transition: border-color var(--transition-base), color var(--transition-base);
            box-shadow: none !important; border-radius: 0; border-left: none; border-top:none; border-bottom: none;
        }
        .accordion-button:focus, .accordion-button.focus {
            box-shadow: none !important;
            border-left-color: transparent !important; /* Ensure no other borders appear on focus */
            border-top-color: transparent !important;
            border-bottom-color: transparent !important;
        }
        .accordion-button.collapsed:focus { border-right-color: transparent !important; } /* Keep right border transparent on focus when collapsed */

        .accordion-button:not(.collapsed) {
            color: var(--bs-accordion-active-color); box-shadow: none !important;
            border-right-color: var(--primary-accent);
        }
        .accordion-button:not(.collapsed):focus { border-right-color: var(--primary-accent) !important; } /* Keep right border on focus when open */

        .accordion-button.collapsed:hover { color: var(--primary-accent-darker); }
        .accordion-button::after { display: none !important; } /* Remove default Bootstrap chevron */

        .fill-accordion-chevron { /* Custom chevron */
            width: 0.9rem; height: 0.9rem; margin-right: auto; margin-left: 0; /* RTL support */
            transition: transform 0.2s ease-in-out; flex-shrink: 0; fill: currentColor;
        }
        .accordion-button:not(.collapsed) .fill-accordion-chevron { transform: rotate(-180deg); }
        .accordion-item { border: none; } /* Remove borders from accordion items */
        .fill-accordion-header-icon { /* Custom icon next to accordion title */
            width: 19px; height: 19px;
            margin-left: calc(var(--spacing-unit) * 0.75); fill: currentColor;
        }

        .fill-price-slider-container { padding: calc(var(--spacing-unit) * 2) calc(var(--spacing-unit) * 1); margin-bottom: var(--spacing-unit); }
        .fill-price-slider-track { position: relative; height: 5px; background-color: var(--border-color); border-radius: 3px; margin: calc(var(--spacing-unit)*1.5) 0; }
        .fill-price-slider-range { position: absolute; height: 100%; background-color: var(--primary-accent); border-radius: 3px; }
        .fill-price-slider-handle {
            position: absolute; top: 50%; transform: translate(-50%, -50%);
            width: 18px; height: 18px; background-color: var(--bg-secondary);
            border: 2px solid var(--primary-accent); border-radius: 50%;
            cursor: grab; box-shadow: var(--shadow-sm); z-index: 2;
        }
        .fill-price-slider-handle:active { cursor: grabbing; box-shadow: var(--shadow-md); transform: translate(-50%, -50%) scale(1.1); }
        .fill-price-display { font-size: 0.85rem; text-align: center; padding: calc(var(--spacing-unit) * 0.5) 0; font-weight: 500; }
        .fill-price-display span { font-weight: 700; color: var(--secondary-accent); margin: 0 3px; }

        .fill-filter-options-list .fill-filter-option { position: relative; border-bottom: 1px solid var(--border-color-light); }
        .fill-filter-options-list .fill-filter-option:last-child { border-bottom: none; }
        .fill-filter-options-list .fill-filter-option input[type="checkbox"],
        .fill-filter-options-list .fill-filter-option input[type="radio"] { opacity: 0; position: absolute; width: 0; height: 0; }
        .fill-filter-options-list .fill-filter-option label {
            display: flex; align-items: center;
            padding: calc(var(--spacing-unit) * 1.25) calc(var(--spacing-unit) * 0.75);
            padding-left: calc(var(--spacing-unit) * 4.5); /* Space for custom tick */
            font-weight: 400;
            font-size: 0.85rem; color: var(--text-secondary); cursor: pointer;
            transition: color var(--transition-base), background-color var(--transition-base);
            width: 100%; position: relative;
        }
        .fill-filter-options-list .fill-filter-option label:hover { color: var(--primary-accent); }

        .fill-custom-tick-container {
            position: absolute; left: calc(var(--spacing-unit) * 1); top: 50%;
            transform: translateY(-50%); width: 22px; height: 22px;
            display: flex; align-items: center; justify-content: center;
        }
        .fill-custom-tick-container::before { /* Animated background circle */
            content: ''; position: absolute; width: 100%; height: 100%;
            background-color: transparent; border-radius: 50%;
            transform: scale(0); transition: var(--transition-tick-bg-anim); z-index: 1;
        }
        .fill-filter-options-list .fill-filter-option input:checked + label .fill-custom-tick-container::before {
            background-color: var(--primary-accent);
            transform: scale(1);
        }
        .fill-custom-tick-container .fill-tick-icon { /* The check mark itself */
            width: 12px; height: 12px; z-index: 2; stroke: white;
            stroke-width: 2.5; fill: none; stroke-dasharray: var(--tick-path-length);
            stroke-dashoffset: var(--tick-path-length);
            transition: stroke-dashoffset var(--transition-tick-draw-duration) var(--cubic-bezier-tick-draw);
            opacity: 0;
        }
        .fill-filter-options-list .fill-filter-option input:checked + label { color: var(--primary-accent); font-weight: 500; }
        .fill-filter-options-list .fill-filter-option input:checked + label .fill-custom-tick-container .fill-tick-icon {
            stroke-dashoffset: 0; transition-delay: var(--transition-tick-draw-delay); opacity: 1;
        }

        .fill-product-card-link {
            color: var(--text-primary);
            text-decoration: none;
        }
        .fill-product-card-link:hover, .fill-product-card-link:focus {
            color: var(--text-primary);
            text-decoration: none;
        }

        .fill-product-card { transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; background-color: var(--bg-secondary); border-radius: var(--border-radius-sm); overflow: hidden; }
        .fill-product-card-link .fill-product-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        .fill-product-card-img { width: 70%; max-width: 70%; object-fit: cover; margin: 10px auto; display: block; }
        .fill-product-card .card-body { padding: var(--spacing-unit); } /* Bootstrap class, but padding is custom */
        .fill-product-card .card-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 4px; line-height: 1.3; } /* Bootstrap class, but styles are custom */
        .fill-product-card .fill-card-brand { font-size: 0.65rem; font-weight: 600; color: var(--primary-accent); text-transform: uppercase; margin-bottom: 2px; }
        .fill-product-card .card-text.fill-description { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; flex-grow: 1; line-height: 1.4; max-height: calc(1.4em * 3); overflow: hidden; text-overflow: ellipsis; word-break: break-word; }
        .fill-product-card .card-price { font-size: 1rem; font-weight: 700; color: var(--text-muted); margin-top: auto; text-align: left; display: flex; justify-content: flex-end; align-items: center; } /* Bootstrap class, but styles are custom */
        .fill-product-card .card-price .fill-price-value { /* Span inside card-price */
            /* No specific style other than what's inherited, but good to have if needed */
        }

        .fill-clear-filters-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: calc(var(--spacing-unit) * 1);
            padding-top: calc(var(--spacing-unit) * 2);
            margin-top: var(--spacing-unit);
        }
        #clearFiltersButton.btn, #applyFiltersMobileButton.btn { /* These are IDs, and .btn is Bootstrap, so no fill- prefix for the class part of the selector. Styling is custom though. */
            font-weight: 500;
            padding: calc(var(--spacing-unit)*0.75) calc(var(--spacing-unit)*1.5);
            border-radius: var(--border-radius-md);
            box-shadow: none !important;
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, color 0.15s ease-in-out !important;
            flex-grow: 1;
            border: 1px solid transparent;
        }
        #clearFiltersButton.btn {
            background-color: var(--primary-accent-lighter);
            border-color: var(--primary-accent-lighter);
            color: var(--bg-secondary);
        }
        #clearFiltersButton.btn:hover, #clearFiltersButton.btn:focus, #clearFiltersButton.btn:active {
            background-color: var(--primary-accent) !important;
            border-color: var(--primary-accent) !important;
            color: white !important;
        }
        #clearFiltersButton.btn svg {
            margin-left: calc(var(--spacing-unit) * 0.75); width: 16px; height: 16px;
            fill: var(--bg-secondary);
        }
        #clearFiltersButton.btn:hover svg, #clearFiltersButton.btn:focus svg, #clearFiltersButton.btn:active svg {
            fill: white !important;
        }

        #applyFiltersMobileButton.btn {
            background-color: var(--primary-accent-lighter);
            border-color: var(--primary-accent-lighter);
            color: var(--bg-secondary);
            display: none; /* Initially hidden, JS will manage */
        }
        #applyFiltersMobileButton.btn:hover,
        #applyFiltersMobileButton.btn:focus,
        #applyFiltersMobileButton.btn:active {
            background-color: var(--primary-accent) !important;
            border-color: var(--primary-accent) !important;
            color: white !important;
        }
        .is-touch-interface #applyFiltersMobileButton.btn { /* .is-touch-interface is not prefixed */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .fill-results-count-container { /* Although d-none, it's a custom class */
            display: none !important; /* Bootstrap d-none is also applied in HTML */
        }

        #openFiltersFab { /* This is an ID, no prefix */
            position: fixed;
            top: 20px;
            right: 20px; /* RTL */
            left: auto; /* RTL */
            min-height: 56px;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            z-index: 1035; /* Bootstrap offcanvas is 1040-1045, so this should be below if sidebar is not in offcanvas */
            box-shadow: var(--shadow-md);
            background-color: var(--primary-accent);
            border-color: var(--primary-accent);
            color: white;
            display: flex; /* d-none is handled by JS */
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        #openFiltersFab svg {
            width: 24px;
            height: 24px;
            stroke: white;
            fill: none;
        }
        #openFiltersFab span {
            font-size: 0.9rem;
        }

        /* Layout rules based on .is-touch-interface (not prefixed) */
        .is-touch-interface .fill-filters-sidebar-container { display: none !important; }
        body:not(.is-touch-interface) #openFiltersFab { display: none !important; }
        body:not(.is-touch-interface) .offcanvas { display: none !important; visibility: hidden !important; }

        .offcanvas-body { padding: 0; } /* Bootstrap class, style is custom */
        .offcanvas-body .fill-filters-sidebar-content-wrapper { /* .fill-filters-sidebar-content-wrapper is custom */
            background-color: var(--bg-secondary); padding: calc(var(--spacing-unit) * 2);
            height: 100%; overflow-y: auto;
            scrollbar-width: thin; scrollbar-color: var(--border-color) var(--bg-secondary);
        }
        .offcanvas-body .fill-filters-sidebar-content-wrapper::-webkit-scrollbar { width: 6px; }
        .offcanvas-body .fill-filters-sidebar-content-wrapper::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 3px; }
        .offcanvas-body .fill-filters-sidebar-content-wrapper::-webkit-scrollbar-track { background-color: var(--bg-secondary); }
        .offcanvas-body .accordion-body { /* Bootstrap class, padding is custom */
            padding-left: calc(var(--spacing-unit) * 1.5);
            padding-right: calc(var(--spacing-unit) * 1.5);
        }

        .offcanvas-header .btn-close:focus { box-shadow: none !important; } /* Bootstrap class, style is custom */

    </style>
</head>
<body>
<div class="container-fluid my-3">
    <div class="row gx-3">
        <aside class="col-lg-3 fill-filters-sidebar-container mb-3 mb-lg-0">
            <!-- Content moved by JS -->
        </aside>

        <main class="col-lg-9">
            <div id="resultsCountDisplay" class="fill-results-count-container d-none"></div>
            <div id="resultsGrid" class="row row-cols-2 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
                <!-- Products... -->
                <div class="col" data-price="45000000" data-category="لپ تاپ" data-brand="آلفا تک">
                    <a href="#" class="fill-product-card-link d-block h-100">
                        <div class="card h-100 fill-product-card">
                            <img src="https://placehold.co/300x200/FF6B6B/fff?text=Laptop+Alpha&font=Vazirmatn" class="card-img-top fill-product-card-img" alt="لپ تاپ آلفا">
                            <div class="card-body d-flex flex-column">
                                <div class="fill-card-brand">لپ تاپ</div>
                                <h5 class="card-title">لپ تاپ حرفه‌ای آلفا</h5>
                                <p class="card-text fill-description flex-grow-1">پردازنده نسل جدید، سبک و مقاوم.</p>
                                <p class="card-price"><span class="fill-price-value">۴۵,۰۰۰,۰۰۰</span> تومان</p>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col" data-price="32500000" data-category="موبایل" data-brand="گاماتل">
                    <a href="#" class="fill-product-card-link d-block h-100">
                        <div class="card h-100 fill-product-card">
                            <img src="https://placehold.co/300x200/4ECDC4/fff?text=Mobile+Gamma&font=Vazirmatn" class="card-img-top fill-product-card-img" alt="موبایل گاما">
                            <div class="card-body d-flex flex-column">
                                <div class="fill-card-brand">موبایل</div>
                                <h5 class="card-title">موبایل هوشمند گاما</h5>
                                <p class="card-text fill-description flex-grow-1">دوربین ۱۰۸ مگاپیکسلی، نمایشگر آمولد.</p>
                                <p class="card-price"><span class="fill-price-value">۳۲,۵۰۰,۰۰۰</span> تومان</p>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col" data-price="12200000" data-category="مانیتور" data-brand="بتاویژن">
                    <a href="#" class="fill-product-card-link d-block h-100">
                        <div class="card h-100 fill-product-card">
                            <img src="https://placehold.co/300x200/20B2AA/fff?text=Monitor+Beta&font=Vazirmatn" class="card-img-top fill-product-card-img" alt="مانیتور بتا">
                            <div class="card-body d-flex flex-column">
                                <div class="fill-card-brand">مانیتور</div>
                                <h5 class="card-title">مانیتور گیمینگ بتا</h5>
                                <p class="card-text fill-description flex-grow-1">نرخ بروزرسانی ۱۴۴ هرتز، پنل IPS.</p>
                                <p class="card-price"><span class="fill-price-value">۱۲,۲۰۰,۰۰۰</span> تومان</p>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col" data-price="800000" data-category="لوازم جانبی" data-brand="سیگماگیر">
                    <a href="#" class="fill-product-card-link d-block h-100">
                        <div class="card h-100 fill-product-card">
                            <img src="https://placehold.co/300x200/F9A826/333?text=Keyboard+Sigma&font=Vazirmatn" class="card-img-top fill-product-card-img" alt="کیبورد سیگما">
                            <div class="card-body d-flex flex-column">
                                <div class="fill-card-brand">سیگماگیر</div>
                                <h5 class="card-title">کیبورد سیگماپرو</h5>
                                <p class="card-text fill-description flex-grow-1">مکانیکی، نورپردازی RGB.</p>
                                <p class="card-price"><span class="fill-price-value">۸۰۰,۰۰۰</span> تومان</p>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col" data-price="1500000" data-category="لوازم جانبی" data-brand="سیگماگیر">
                    <a href="#" class="fill-product-card-link d-block h-100">
                        <div class="card h-100 fill-product-card">
                            <img src="https://placehold.co/300x200/F9A826/333?text=Mouse+Sigma&font=Vazirmatn" class="card-img-top fill-product-card-img" alt="موس سیگما">
                            <div class="card-body d-flex flex-column">
                                <div class="fill-card-brand">سیگماگیر</div>
                                <h5 class="card-title">موس گیمینگ سیگما</h5>
                                <p class="card-text fill-description flex-grow-1">دقت بالا، طراحی ارگونومیک.</p>
                                <p class="card-price"><span class="fill-price-value">۱,۵۰۰,۰۰۰</span> تومان</p>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
            <div id="noResultsMessage" class="alert alert-warning mt-3 d-none" role="alert">
                متاسفانه محصولی با این فیلترها یافت نشد. :(
            </div>
        </main>
    </div>
</div>

<div id="filtersSidebarContentTemplate" style="display: none;">
    <div class="fill-filters-sidebar-content-wrapper">
        <div class="fill-sidebar-header">فیلتر محصولات</div>
        <div class="accordion" id="filtersAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingPrice">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrice" aria-expanded="false" aria-controls="collapsePrice">
                        <svg class="fill-accordion-header-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v2.14c1.72.45 3 2 3 3.86 0 2.21-1.79 4-4 4s-4-1.79-4-4c0-1.86 1.28-3.41 3-3.86V7zm2 5c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1z"></path></svg>
                        محدوده قیمت
                        <svg class="fill-accordion-chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                    </button>
                </h2>
                <div id="collapsePrice" class="accordion-collapse collapse" aria-labelledby="headingPrice" data-bs-parent="#filtersAccordion">
                    <div class="accordion-body">
                        <div class="fill-price-slider-container">
                            <div class="fill-price-slider-track" id="priceSliderTrack">
                                <div class="fill-price-slider-range" id="priceSliderRange"></div>
                                <div class="fill-price-slider-handle" id="maxPriceHandle" data-handle="min-visual"></div>
                                <div class="fill-price-slider-handle" id="minPriceHandle" data-handle="max-visual"></div>
                            </div>
                        </div>
                        <div class="fill-price-display">
                            از <span id="maxPriceDisplay">-</span> تا <span id="minPriceDisplay">-</span> تومان</div>
                        <input type="hidden" id="minPriceValue">
                        <input type="hidden" id="maxPriceValue">
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingCategory">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCategory" aria-expanded="false" aria-controls="collapseCategory">
                        <svg class="fill-accordion-header-icon" viewBox="0 0 24 24"><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58s1.05-.22 1.41-.58l7-7c.79-.78.79-2.05 0-2.83zm-9.41 8.83L4 11.81V4h7l9 9-7.59 7.59zM6.5 7.5c-.83 0-1.5-.67-1.5-1.5S5.67 4.5 6.5 4.5 8 5.17 8 6s-.67 1.5-1.5 1.5z"></path></svg>
                        دسته بندی
                        <svg class="fill-accordion-chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                    </button>
                </h2>
                <div id="collapseCategory" class="accordion-collapse collapse" aria-labelledby="headingCategory" data-bs-parent="#filtersAccordion">
                    <div class="accordion-body fill-filter-options-list" id="categoryFilterContainer"></div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingBrand">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBrand" aria-expanded="false" aria-controls="collapseBrand">
                        <svg class="fill-accordion-header-icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"></path></svg>
                        برند
                        <svg class="fill-accordion-chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                    </button>
                </h2>
                <div id="collapseBrand" class="accordion-collapse collapse" aria-labelledby="headingBrand" data-bs-parent="#filtersAccordion">
                    <div class="accordion-body fill-filter-options-list" id="brandFilterContainer"></div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingSort">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSort" aria-expanded="false" aria-controls="collapseSort">
                        <svg class="fill-accordion-header-icon" viewBox="0 0 24 24"><path d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z"></path></svg>
                        مرتب‌سازی
                        <svg class="fill-accordion-chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                    </button>
                </h2>
                <div id="collapseSort" class="accordion-collapse collapse" aria-labelledby="headingSort" data-bs-parent="#filtersAccordion">
                    <div class="accordion-body fill-filter-options-list" id="sortOptionsContainer"></div>
                </div>
            </div>
        </div>
        <div class="fill-clear-filters-container">
            <button id="clearFiltersButton" class="btn">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
                پاک کردن فیلترها
            </button>
            <button id="applyFiltersMobileButton" class="btn">
                اعمال فیلترها
            </button>
        </div>
    </div>
</div>


<button class="btn shadow-lg d-none" id="openFiltersFab" type="button" aria-controls="filtersOffcanvas" aria-label="باز کردن فیلترها">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em">
        <g stroke="currentColor" stroke-linecap="round">
            <path d="M10 8h10M4 16h10"></path>
            <circle cx="7" cy="8" r="3" transform="rotate(90 7 8)"></circle>
            <circle cx="17" cy="16" r="3" transform="rotate(90 17 16)"></circle>
        </g>
    </svg>
    <span>فیلتر ها</span>
</button>

<div class="offcanvas offcanvas-start" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title" id="filtersOffcanvasLabel">فیلتر محصولات</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body" id="offcanvasFilterBody">
        <!-- Content moved by JS -->
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const resultsGrid = document.getElementById('resultsGrid');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const allProductCards = Array.from(resultsGrid.querySelectorAll('.col[data-price]'));

        // Elements to be found after filter content is in place
        let categoryFilterContainer, brandFilterContainer, sortOptionsContainer;
        let mainClearFiltersButton, applyFiltersMobileButton;
        let sidebarHeaderElement;

        let debounceTimer;
        let actualMinProductPrice = 0;
        let actualMaxProductPrice = 100000000;
        let filterIdCounter = 0;

        const tickSVGPath = "M4.5 8.5l2.5 2.5 5-5";
        const tempSVG = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        const tempPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        tempPath.setAttribute("d", tickSVGPath);
        tempPath.style.strokeWidth = "2.5"; tempPath.style.fill = "none";
        tempSVG.appendChild(tempPath); document.body.appendChild(tempSVG);
        const pathLength = tempPath.getTotalLength(); document.body.removeChild(tempSVG);
        document.documentElement.style.setProperty('--tick-path-length', pathLength.toFixed(2));
        const tickSVG = `<svg class="fill-tick-icon" viewBox="0 0 16 16"><path d="${tickSVGPath}" /></svg>`; // Prefixed tick-icon

        const filtersSidebarDOMContainer = document.querySelector('.fill-filters-sidebar-container'); // Prefixed
        const offcanvasFilterBody = document.getElementById('offcanvasFilterBody');
        const openFiltersFab = document.getElementById('openFiltersFab');
        const filtersOffcanvasEl = document.getElementById('filtersOffcanvas');
        const filtersOffcanvasInstance = filtersOffcanvasEl ? new bootstrap.Offcanvas(filtersOffcanvasEl) : null;
        const lgBreakpoint = 992;

        const filtersTemplate = document.getElementById('filtersSidebarContentTemplate');
        const filterContentWrapper = filtersTemplate.querySelector('.fill-filters-sidebar-content-wrapper'); // Prefixed
        filtersTemplate.remove();

        function initializeDynamicElements() {
            categoryFilterContainer = filterContentWrapper.querySelector('#categoryFilterContainer');
            brandFilterContainer = filterContentWrapper.querySelector('#brandFilterContainer');
            sortOptionsContainer = filterContentWrapper.querySelector('#sortOptionsContainer');
            mainClearFiltersButton = filterContentWrapper.querySelector('#clearFiltersButton'); // ID, no prefix
            applyFiltersMobileButton = filterContentWrapper.querySelector('#applyFiltersMobileButton'); // ID, no prefix
            sidebarHeaderElement = filterContentWrapper.querySelector('.fill-sidebar-header'); // Prefixed
        }

        function formatPrice(value) { return Number(value).toLocaleString('fa-IR');}

        function updatePriceSliderDisplays(currentMin, currentMax) {
            const dMin = document.getElementById('maxPriceDisplay');
            const dMax = document.getElementById('minPriceDisplay');
            const iMin = document.getElementById('minPriceValue');
            const iMax = document.getElementById('maxPriceValue');

            if (!dMin || !dMax || !iMin || !iMax) return;
            dMin.textContent = formatPrice(currentMin);
            dMax.textContent = formatPrice(currentMax);
            iMin.value = (currentMin === '-' || currentMin === '') ? '' : currentMin;
            iMax.value = (currentMax === '-' || currentMax === '') ? '' : currentMax;
        }

        function populateFiltersAndGetPriceRange() {
            if (!categoryFilterContainer || !brandFilterContainer) return;
            const categories = new Set(); const brands = new Set();
            let minP = Infinity; let maxP = 0;
            allProductCards.forEach(cardEl => { // Renamed card to cardEl to avoid conflict with .card class
                if (cardEl.dataset.category) categories.add(cardEl.dataset.category);
                if (cardEl.dataset.brand) brands.add(cardEl.dataset.brand);
                const price = parseFloat(cardEl.dataset.price);
                if (!isNaN(price)) { if (price < minP) minP = price; if (price > maxP) maxP = price; }
                const priceEl = cardEl.querySelector('.fill-price-value'); // Prefixed
                if (priceEl) priceEl.textContent = formatPrice(price);
            });
            actualMinProductPrice = (minP === Infinity || allProductCards.length === 0) ? 0 : minP;
            actualMaxProductPrice = (maxP === 0 || allProductCards.length === 0) ? 100000000 : maxP;

            categoryFilterContainer.innerHTML = '';
            categories.forEach(c => createFilterOption(c, categoryFilterContainer, 'category', 'checkbox'));
            brandFilterContainer.innerHTML = '';
            brands.forEach(b => createFilterOption(b, brandFilterContainer, 'brand', 'checkbox'));
            populateSortOptions();
            initializePriceSlider();
        }

        function createFilterOption(value, container, groupName, type = 'checkbox') {
            const optDiv = document.createElement('div'); optDiv.className = 'fill-filter-option'; // Prefixed
            const inp = document.createElement('input'); inp.type = type;
            const id = `${groupName}-filter-${filterIdCounter++}`; inp.id = id;
            inp.value = (type === 'radio' && groupName === 'sort') ? value.value : value;
            if (type === 'radio') inp.name = `${groupName}Option`;
            const lbl = document.createElement('label'); lbl.htmlFor = id;
            lbl.textContent = (type === 'radio' && groupName === 'sort') ? value.label : value;
            const tickCont = document.createElement('span'); tickCont.className = 'fill-custom-tick-container'; // Prefixed
            tickCont.innerHTML = tickSVG; lbl.appendChild(tickCont);
            optDiv.appendChild(inp); optDiv.appendChild(lbl); container.appendChild(optDiv);
            inp.addEventListener('change', () => {
                clearTimeout(debounceTimer);
                if (!document.body.classList.contains('is-touch-interface')) {
                    debounceTimer = setTimeout(performSearchAndFilter, 300);
                }
            });
            return inp;
        }
        function populateSortOptions() {
            if (!sortOptionsContainer) return;
            sortOptionsContainer.innerHTML = '';
            const sortOpts = [
                { value: 'price-asc', label: 'پر بازدیدترین' },
                { value: 'price-asc', label: 'جدیدترین' },
                { value: 'price-asc', label: 'محبوب ترین', checked: true },
                { value: 'price-desc', label: 'ارزان ترین' },
                { value: 'price-desc', label: 'گران‌ترین' },
            ];
            sortOpts.forEach(opt => { const radio = createFilterOption(opt, sortOptionsContainer, 'sort', 'radio'); if (opt.checked) radio.checked = true; });
        }

        function initializePriceSlider() {
            const hMin = document.getElementById('maxPriceHandle');
            const hMax = document.getElementById('minPriceHandle');
            const pTrack = document.getElementById('priceSliderTrack');
            const pRange = document.getElementById('priceSliderRange');

            if (!hMin || !hMax || !pTrack || !pRange) return;
            updateHandlePosition(hMin, 0);
            updateHandlePosition(hMax, 100);
            updateSliderRangeFill(hMin, hMax, pRange);
            updatePriceSliderDisplays(actualMinProductPrice, actualMaxProductPrice);
            [hMin, hMax].forEach(handle => {
                handle.addEventListener('mousedown', startDrag);
                handle.addEventListener('touchstart', startDrag, { passive: false });
            });
        }

        let currentHandle = null; let sliderRect = null; let isDragging = false;

        function startDrag(e) {
            if (e.cancelable) e.preventDefault();
            const hMin = document.getElementById('maxPriceHandle');
            const hMax = document.getElementById('minPriceHandle');
            const pTrack = document.getElementById('priceSliderTrack');

            if (e.target.closest('#maxPriceHandle')) currentHandle = hMin;
            else if (e.target.closest('#minPriceHandle')) currentHandle = hMax;
            else return;

            isDragging = true; currentHandle.style.zIndex = '3';
            sliderRect = pTrack.getBoundingClientRect();
            window.addEventListener('mousemove', onDrag);
            window.addEventListener('mouseup', endDrag);
            window.addEventListener('touchmove', onDrag, { passive: false });
            window.addEventListener('touchend', endDragSlider);
            window.addEventListener('touchcancel', endDragSlider);
        }

        function onDrag(e) {
            if (!isDragging || !currentHandle || !sliderRect) return;
            if (e.cancelable) e.preventDefault();
            let clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
            let percent = ((clientX - sliderRect.left) / sliderRect.width) * 100;
            percent = Math.max(0, Math.min(100, percent));

            const hMin = document.getElementById('maxPriceHandle');
            const hMax = document.getElementById('minPriceHandle');
            const pRange = document.getElementById('priceSliderRange');

            let minPriceHandlePercent = parseFloat(hMin.style.left);
            let maxPriceHandlePercent = parseFloat(hMax.style.left);

            if (currentHandle === hMin) {
                percent = Math.min(percent, maxPriceHandlePercent - 0.5);
            } else {
                percent = Math.max(percent, minPriceHandlePercent + 0.5);
            }
            percent = Math.max(0, Math.min(100, percent));

            updateHandlePosition(currentHandle, percent);
            updateSliderRangeFill(hMin, hMax, pRange);

            let selectedMinValue = actualMinProductPrice + (actualMaxProductPrice - actualMinProductPrice) * (parseFloat(hMin.style.left) / 100);
            let selectedMaxValue = actualMinProductPrice + (actualMaxProductPrice - actualMinProductPrice) * (parseFloat(hMax.style.left) / 100);

            updatePriceSliderDisplays(Math.round(selectedMinValue), Math.round(selectedMaxValue));
        }

        function endDrag() {
            if (!isDragging) return;
            isDragging = false;
            if (currentHandle) currentHandle.style.zIndex = '2';
            currentHandle = null;
            window.removeEventListener('mousemove', onDrag);
            window.removeEventListener('mouseup', endDrag);

            if (!document.body.classList.contains('is-touch-interface')) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(performSearchAndFilter, 300);
            }
        }
        function endDragSlider() {
            if (!isDragging) return;
            isDragging = false;
            if (currentHandle) currentHandle.style.zIndex = '2';
            currentHandle = null;
            window.removeEventListener('touchmove', onDrag);
            window.removeEventListener('touchend', endDragSlider);
            window.removeEventListener('touchcancel', endDragSlider);
            if (!document.body.classList.contains('is-touch-interface') || !applyFiltersMobileButton || applyFiltersMobileButton.style.display === 'none') {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(performSearchAndFilter, 300);
            }
        }

        function updateHandlePosition(handle, percent) { if(handle) handle.style.left = `${percent}%`; }
        function updateSliderRangeFill(hMin, hMax, pRange) {
            if (!hMin || !hMax || !pRange) return;
            const minPercent = parseFloat(hMin.style.left);
            const maxPercent = parseFloat(hMax.style.left);
            pRange.style.left = `${minPercent}%`;
            pRange.style.width = `${maxPercent - minPercent}%`;
        }

        function getSelectedFilters(containerId) {
            const container = filterContentWrapper.querySelector(`#${containerId}`);
            if (!container) return [];
            const selected = [];
            container.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => selected.push(cb.value));
            return selected;
        }
        function performSearchAndFilter() {
            const iMin = document.getElementById('minPriceValue');
            const iMax = document.getElementById('maxPriceValue');
            const sOptionsContainer = filterContentWrapper.querySelector('#sortOptionsContainer');

            const minPrice = parseFloat(iMin.value === '' || iMin.value === '-' ? actualMinProductPrice : iMin.value);
            const maxPrice = parseFloat(iMax.value === '' || iMax.value === '-' ? actualMaxProductPrice : iMax.value);

            const selectedCategories = getSelectedFilters('categoryFilterContainer');
            const selectedBrands = getSelectedFilters('brandFilterContainer');
            const selectedSortOptionInput = sOptionsContainer ? sOptionsContainer.querySelector('input[name="sortOption"]:checked') : null;
            const selectedSortValue = selectedSortOptionInput ? selectedSortOptionInput.value : 'price-asc';
            let visibleProductCards = [];
            allProductCards.forEach(cardEl => {
                const productPrice = parseFloat(cardEl.dataset.price);
                const productCategory = cardEl.dataset.category || '';
                const productBrand = cardEl.dataset.brand || '';
                const matchesPrice = productPrice >= minPrice && productPrice <= maxPrice;
                const matchesCategory = selectedCategories.length === 0 || selectedCategories.includes(productCategory);
                const matchesBrand = selectedBrands.length === 0 || selectedBrands.includes(productBrand);
                if (matchesPrice && matchesCategory && matchesBrand) { visibleProductCards.push(cardEl); }
            });
            if (selectedSortValue === 'price-asc') visibleProductCards.sort((a, b) => parseFloat(a.dataset.price) - parseFloat(b.dataset.price));
            else if (selectedSortValue === 'price-desc') visibleProductCards.sort((a, b) => parseFloat(b.dataset.price) - parseFloat(a.dataset.price));

            resultsGrid.innerHTML = '';
            visibleProductCards.forEach(cardEl => resultsGrid.appendChild(cardEl));
            noResultsMessage.classList.toggle('d-none', visibleProductCards.length > 0);
        }

        function setupEventListeners() {
            if (mainClearFiltersButton) {
                mainClearFiltersButton.addEventListener('click', () => {
                    const hMin = document.getElementById('maxPriceHandle');
                    const hMax = document.getElementById('minPriceHandle');
                    const pRange = document.getElementById('priceSliderRange');
                    const catFilterContainer = filterContentWrapper.querySelector('#categoryFilterContainer');
                    const brFilterContainer = filterContentWrapper.querySelector('#brandFilterContainer');
                    const sOptionsContainer = filterContentWrapper.querySelector('#sortOptionsContainer');

                    if (hMin && hMax) {
                        updateHandlePosition(hMin, 0);
                        updateHandlePosition(hMax, 100);
                        updateSliderRangeFill(hMin, hMax, pRange);
                    }
                    updatePriceSliderDisplays(actualMinProductPrice, actualMaxProductPrice);
                    if (catFilterContainer) catFilterContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    if (brFilterContainer) brFilterContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    if (sOptionsContainer) {
                        const popularSortRadio = Array.from(sOptionsContainer.querySelectorAll('input[name="sortOption"]')).find(radio => radio.labels[0].textContent === "محبوب ترین");
                        if (popularSortRadio && !popularSortRadio.checked) {
                            popularSortRadio.checked = true;
                        } else if (!popularSortRadio) {
                            const firstSortRadio = sOptionsContainer.querySelector('input[name="sortOption"]');
                            if (firstSortRadio) firstSortRadio.checked = true;
                        }
                    }
                    if (!document.body.classList.contains('is-touch-interface')) {
                        performSearchAndFilter();
                    }
                });
            }

            if (openFiltersFab) {
                openFiltersFab.addEventListener('click', () => {
                    if (filtersOffcanvasInstance) {
                        manageFilterLayout();
                        filtersOffcanvasInstance.show();
                    }
                });
            }

            if (applyFiltersMobileButton) {
                applyFiltersMobileButton.addEventListener('click', () => {
                    performSearchAndFilter();
                    if (filtersOffcanvasInstance) filtersOffcanvasInstance.hide();
                });
            }
        }

        function isTouchDevice() {
            return (('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0));
        }

        function manageFilterLayout() {
            if (!filtersSidebarDOMContainer || !filterContentWrapper || !offcanvasFilterBody || !openFiltersFab || !filtersOffcanvasInstance || !sidebarHeaderElement) return;
            const shouldUseMobileLayout = isTouchDevice() || window.innerWidth < lgBreakpoint;

            if (shouldUseMobileLayout) {
                document.body.classList.add('is-touch-interface');
                openFiltersFab.classList.remove('d-none');
                filtersSidebarDOMContainer.classList.add('d-none');
                if (applyFiltersMobileButton) applyFiltersMobileButton.style.display = 'inline-flex';

                if (!offcanvasFilterBody.contains(filterContentWrapper)) {
                    offcanvasFilterBody.appendChild(filterContentWrapper);
                }
                sidebarHeaderElement.classList.add('fill-sidebar-header-hidden-in-offcanvas'); // Prefixed
            } else {
                document.body.classList.remove('is-touch-interface');
                openFiltersFab.classList.add('d-none');
                filtersSidebarDOMContainer.classList.remove('d-none');
                if (applyFiltersMobileButton) applyFiltersMobileButton.style.display = 'none';

                if (filtersOffcanvasInstance && filtersOffcanvasEl.classList.contains('show')) {
                    filtersOffcanvasInstance.hide();
                }
                if (!filtersSidebarDOMContainer.contains(filterContentWrapper)) {
                    filtersSidebarDOMContainer.appendChild(filterContentWrapper);
                }
                sidebarHeaderElement.classList.remove('fill-sidebar-header-hidden-in-offcanvas'); // Prefixed
            }
        }

        // --- Initialization Flow ---
        initializeDynamicElements();
        manageFilterLayout();
        populateFiltersAndGetPriceRange();
        setupEventListeners();
        window.addEventListener('resize', manageFilterLayout);
    });
</script>
</body>
</html>